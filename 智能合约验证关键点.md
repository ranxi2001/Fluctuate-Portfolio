# 智能合约验证关键点

## 验证成功命令

```bash
forge verify-contract <合约地址> <合约路径:合约名> \
  --verifier-url "https://api.etherscan.io/v2/api?chainid=<链ID>" \
  --etherscan-api-key <API_KEY> \
  --compiler-version "v0.8.20+commit.a1b79de6" \
  --watch
```

### Mantle Sepolia 示例

```bash
forge verify-contract 0xa37CD611Ff745548926b7ed121Ba825A61226149 \
  src/FluctuatePortfolio.sol:FluctuatePortfolio \
  --verifier-url "https://api.etherscan.io/v2/api?chainid=5003" \
  --etherscan-api-key C7AYY8E9T7U619XIIJ6DJZEXUID8UFZU7K \
  --compiler-version "v0.8.20+commit.a1b79de6" \
  --watch
```

---

## 关键要点

### 1. 使用 Etherscan V2 API

> ⚠️ **重要**: 传统的链专属 API（如 `api.mantlescan.xyz`）已弃用，必须使用 **Etherscan V2 统一端点**。

```
https://api.etherscan.io/v2/api?chainid=<链ID>
```

| 网络 | Chain ID |
|------|----------|
| Mantle Sepolia | 5003 |
| Mantle Mainnet | 5000 |

### 2. 编译器版本格式

> ⛔ **注意**: 必须使用**完整版本格式**，否则会返回 `Invalid compiler version` 错误。

| ❌ 错误格式 | ✅ 正确格式 |
|------------|-----------|
| `0.8.20` | `v0.8.20+commit.a1b79de6` |

查看支持的编译器版本：https://etherscan.io/solcversions

### 3. 优先使用 Forge 内置命令

`forge verify-contract` 优势：
- 自动处理源码展平（flatten）
- 自动包含优化参数和构造函数参数
- 支持 `--watch` 自动轮询验证状态

### 4. 常见参数

| 参数 | 说明 |
|------|------|
| `--num-of-optimizations 200` | 优化次数（需与部署时一致） |
| `--constructor-args <hex>` | ABI 编码的构造函数参数 |
| `--watch` | 自动轮询直到验证完成 |

---

## 故障排查

| 错误信息 | 解决方案 |
|---------|---------|
| `Invalid compiler version` | 使用完整版本格式 `v0.8.x+commit.xxx` |
| `switch to Etherscan API V2` | 使用 V2 端点 + chainid 参数 |
| `bytecode mismatch` | 确保优化参数、编译器版本与部署时一致 |
| `tls handshake eof` | 网络问题，换用 V2 API 或重试 |

---

## 验证结果

- **合约地址**: `0xa37CD611Ff745548926b7ed121Ba825A61226149`
- **网络**: Mantle Sepolia (Chain ID: 5003)
- **状态**: ✅ 已验证
- **浏览器**: https://sepolia.mantlescan.xyz/address/0xa37CD611Ff745548926b7ed121Ba825A61226149#code
